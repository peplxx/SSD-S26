# Static Application Security Testing

> <https://github.com/resources/articles/what-is-sast>

**Static Application Security Testing (SAST)** involves analyzing source code to identify security vulnerabilities without executing the program.

- **Pattern Matching**: simple matching (e.g., using regex) for known bad practices.

  - Example: matching for `verify=False` in `jwt.decode`

- **Taint Analysis**: tracking the flow of untrusted data throughout the code to ensure it doesn't reach a vulnerable function call.

  - Example: ensuring user input doesn't end up processed by `os.system`, `pickle.load`, or `cur.execute` (for a db cursor).

## Semgrep

Semgrep is a popular SAST tool that implements pattern matching and taint analysis. It supports [many](https://semgrep.dev/docs/supported-languages) languages and maintains a registry of useful [rulesets](https://semgrep.dev/p/owasp-top-ten).

- Example 1: [matching for path traversal in Flask](https://semgrep.dev/playground/r/python.flask.security.injection.path-traversal-open.path-traversal-open).

- Example 2: [matching for code injection in Express.js](https://semgrep.dev/playground/r/javascript.express.security.express-sandbox-injection.express-sandbox-code-injection)

## Practice

> Goal: Scan a vulnerable application locally using Semgrep CLI.

1. Create `app.py` with the following vulnerable code

    ```python
    import sqlite3
    from flask import Flask, request

    app = Flask(__name__)

    @app.route("/user")
    def get_user():
        username = request.args.get('username')
        conn = sqlite3.connect('example.db')
        c = conn.cursor()
        query = "SELECT * FROM users WHERE username = '" + username + "'"
        c.execute(query)
        return str(c.fetchone())
    ```

1. Install `semgrep` CLI globally with pipx.

    ```bash
    sudo apt install -y pipx
    pipx install --include-deps semgrep
    pipx ensurepath
    ```

1. Run a scan against the current directory using the default ruleset.

    ```bash
    semgrep scan app.py
    ```

## Task 3

> Goal: Integrate Semgrep scan in CI pipeline

1. Push a sample vulnerable app to your deployed GitLab instance (e.g., [DVWA](https://github.com/digininja/DVWA), [DVJA](https://github.com/appsecco/dvja), [Juice-Shop](https://github.com/juice-shop/juice-shop))

1. Create a `.gitlab-ci.yml` file to run Semgrep in the pipeline.
    - Ensure the job runs on your runner created earlier and use OWASP Top 10 [ruleset](https://semgrep.dev/p/owasp-top-ten)

## Task 3 (Alt.)

> In case of problems with AWS access, or just as a bonus activity.

1. Push a sample vulnerable app to local Gitea instance (e.g., [DVWA](https://github.com/digininja/DVWA), [DVJA](https://github.com/appsecco/dvja), [Juice-Shop](https://github.com/juice-shop/juice-shop))

1. Create a `.drone.yml` file to run Semgrep in the pipeline.
    - Ensure the job runs on your runner created earlier and use OWASP Top 10 [ruleset](https://semgrep.dev/p/owasp-top-ten).
