# Application Deployment

After provisioning infrastructure, one typically needs to prepare it for usage by installing and configuring needed software and services.

- This can also be done automatically with "configuration management" tools

## Practice

> Goal: Deploy community-edition GitLab server on the provisioned cloud instance.

[Self hosting](https://github.com/awesome-selfhosted/awesome-selfhosted) services typically involves running a containerized application and utilizing volumes for configuration and data persistence across restarts.

1. Install docker engine in your cloud instance

    ```bash
    sudo apt update
    sudo apt install -y docker.io
    sudo usermod -aG docker $USER
    ```

1. Disconnect and reconnect over SSH to apply group changes, then test installation

    ```bash
    docker run hello-world
    ```

1. Install docker compose CLI ([docs](https://docs.docker.com/compose/install/linux/#install-the-plugin-manually))

    ```bash
    DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
    
    mkdir -p $DOCKER_CONFIG/cli-plugins
    
    curl -SL https://github.com/docker/compose/releases/download/v5.0.1/docker-compose-linux-x86_64 -o $DOCKER_CONFIG/cli-plugins/docker-compose
    
    chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose

    docker compose version
    ```

1. Create `gitlab.rb` to override configuration. Refer to the [configuration template](https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template) to understand defaults and customize as needed. Here is an example config to disable some unneeded services for our usecase.

    ```ruby
    registry['enable'] = false
    mattermost['enable'] = false
    gitlab_pages['enable'] = false
    gitlab_kas['enable'] = false
    ```

1. Create `docker-compose.yaml` to run gitlab server.

    ```yaml
    name: gitlab
    services:
        gitlab:
            image: gitlab/gitlab-ce:latest
            container_name: gitlab
            ports:
                - "80:80"
            volumes:
                - ./gitlab.rb:/etc/gitlab/gitlab.rb
                - gitlab_data:/var/opt/gitlab
            restart: unless-stopped
    volumes:
        gitlab_data:
    ```

1. Start the service. Test accessiblity by visiting `http://<instance-ip>`

    ```bash
    docker compose up -d
    ```

---

<details>
<summary>Notes on production deployments</summary>

Production deployments often involve further configuration: the overall goal is to customize, optimize, and (most importantly) secure the installation. Here are some examples from each category:

<ul>
<li><b>Customize</b>: change default theme or enable a 3rd-party service.</li>
<li><b>Optimize</b>: adjust the number of server worker processes or disable unneeded services</li>
<li><b>Secure</b>: disable public account creation and configure HTTPS with TLS certificates</li>
</ul>

</details>

## Task 2

1. Configure dynamic DNS (e.g., [DuckDNS](https://duckdns.org/)) to avoid working with the temporary instance IP.

1. Configure a reverse proxy (e.g., [Caddy]([Caddy](https://caddyserver.com/))) to serve the application over HTTPS.

1. Install and register a GitLab Runner in docker ([docs](https://docs.gitlab.com/runner/install/docker/)) to run your CI/CD pipelines.

## Task 2 (Alt.)

> In case of problems with AWS access, or just as a bonus activity.

Deploy and Configure [Gitea](https://docs.gitea.com/installation/install-with-docker) + [Drone](https://docs.drone.io/server/provider/gitea/) locally as a lightweight self-hosted alternative to GitLab CI/CD.
